<!doctype html>
<meta charset="utf-8" />
<title>Call</title>
<h1>Audio Call</h1>
<button id="mute">Mute</button>
<button id="leave">Leave</button>
<div id="status"></div>

<script>
    const params = new URLSearchParams(location.search)
    const token = params.get('t')
    if (!token) document.getElementById('status').textContent = 'No token'

    const peers = new Map()
    const streams = new Map()
    let localStream

    const pcConfig = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
        ]
    }

    start()

    async function start() {
        document.getElementById('status').textContent = 'Requesting mic...'
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false })
        } catch (e) {
            document.getElementById('status').textContent = 'Mic denied'
            throw e
        }

        const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws?token=' + encodeURIComponent(token))

        let selfId = null
        ws.onmessage = async (ev) => {
            const msg = JSON.parse(ev.data)
            if (msg.type === 'hello') {
                selfId = msg.peerId
                document.getElementById('status').textContent = 'Connected. Peers: ' + msg.peers.length
                for (const other of msg.peers) await connectTo(other, true)
            } else if (msg.type === 'peer-join') {
                await connectTo(msg.peerId, true) // новый — тоже инициируем
            } else if (msg.type === 'peer-leave') {
                closePeer(msg.peerId)
            } else if (msg.type === 'signal') {
                await handleSignal(msg.from, msg.data)
            }
        }

        ws.onclose = () => {
            document.getElementById('status').textContent = 'Disconnected'
            for (const id of peers.keys()) closePeer(id)
        }

        async function connectTo(peerId, isInitiator) {
            if (peers.has(peerId)) return peers.get(peerId)

            const pc = new RTCPeerConnection(pcConfig)
            peers.set(peerId, pc)
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream))

            pc.ontrack = (e) => {
                let s = streams.get(peerId)
                if (!s) {
                    s = new Audio()
                    s.autoplay = true
                    streams.set(peerId, s)
                    document.body.appendChild(s)
                }
                s.srcObject = e.streams[0]
            }
            pc.onicecandidate = (e) => {
                if (e.candidate) ws.send(JSON.stringify({ type: 'signal', target: peerId, data: { candidate: e.candidate } }))
            }

            if (isInitiator) {
                const offer = await pc.createOffer()
                await pc.setLocalDescription(offer)
                ws.send(JSON.stringify({ type: 'signal', target: peerId, data: { sdp: pc.localDescription } }))
            }
            return pc
        }

        async function handleSignal(from, data) {
            let pc = peers.get(from)
            if (!pc) pc = await connectTo(from, false)

            if (data.sdp) {
                await pc.setRemoteDescription(new RTCSessionDescription(data.sdp))
                if (data.sdp.type === 'offer') {
                    const answer = await pc.createAnswer()
                    await pc.setLocalDescription(answer)
                    ws.send(JSON.stringify({ type: 'signal', target: from, data: { sdp: pc.localDescription } }))
                }
            } else if (data.candidate) {
                try { await pc.addIceCandidate(new RTCIceCandidate(data.candidate)) } catch {}
            }
        }

        function closePeer(id) {
            const pc = peers.get(id)
            if (pc) { pc.getSenders().forEach(s => s.track?.stop()); pc.close(); peers.delete(id) }
            const el = streams.get(id); if (el) { el.srcObject = null; el.remove(); streams.delete(id) }
        }

        document.getElementById('mute').onclick = () => {
            const on = localStream.getAudioTracks()[0].enabled
            localStream.getAudioTracks()[0].enabled = !on
            document.getElementById('mute').textContent = on ? 'Unmute' : 'Mute'
        }
        document.getElementById('leave').onclick = () => window.close() || (location.href = '/')
    }
</script>
